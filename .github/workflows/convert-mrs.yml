name: Convert Multiple TXT to MRS

on:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨 0:00 自动运行
  workflow_dispatch: # 支持手动触发

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Go (for Mihomo CLI)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Mihomo CLI
        run: |
          go install github.com/metacubex/mihomo@latest
          sudo cp ~/go/bin/mihomo /usr/local/bin/

      - name: Process each TXT URL
        run: |
          set +e
          # 从 GitHub Repository Variables 读取 URL 列表
          IFS=',' read -ra URLS <<< "${{ vars.TXT_URLS }}"
          DEFAULT_BEHAVIOR="${{ vars.DEFAULT_BEHAVIOR || 'domain' }}"
          CHANGED=false
          PROCESSED=0

          for RAW_URL in "${URLS[@]}"; do
            # 清理 URL 字符串中的空格
            URL=$(echo "$RAW_URL" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [ -z "$URL" ]; then continue; fi
            
            echo "-------------------------------------------------------"
            echo "Downloading: $URL"
            
            if ! curl -L -o temp_raw.txt -f --max-time 30 "$URL"; then
              echo "Error: Failed to download $URL"
              continue
            fi

            # 移除 BOM 头并检查内容
            sed -i '1s/^\xEF\xBB\xBF//' temp_raw.txt
            if [ ! -s temp_raw.txt ]; then echo "Empty file, skipping."; continue; fi

            # 1. 自动判断 Behavior (IP 类 vs 域名类)
            if grep -qiE "(IP-CIDR|GEOIP|CIDR)" temp_raw.txt 2>/dev/null; then
              BEHAVIOR="ipcidr"
              cp temp_raw.txt temp.txt
              echo "Detected Type: IP-CIDR"
            else
              BEHAVIOR="domain"
              echo "Detected Type: Domain (Applying Wildcard Logic)"
              
              # 2. 执行核心转换逻辑：
              # - 忽略空行和注释
              # - DOMAIN-KEYWORD -> *keyword*
              # - DOMAIN/DOMAIN-SUFFIX/纯域名 -> +.domain.com
              grep -v '^[[:space:]]*$' temp_raw.txt | grep -v '^[[:space:]]*#' | sed -E '
                  /^DOMAIN-KEYWORD,/ {
                      s/^DOMAIN-KEYWORD,([^,]+).*/\*\1\*/;
                      b;
                  }
                  s/^(DOMAIN-SUFFIX|DOMAIN),//g;
                  s/^[[:space:]]*//;
                  s/^\+\.//;
                  s/^\.//;
                  s/^/+\./;
              ' > temp.txt
            fi

            # 预览前 5 行转换结果
            echo "Sample Output:"
            head -n 5 temp.txt | sed 's/^/  /'

            # 3. 编译为 MRS 文件
            FILENAME=$(basename "$URL" .txt).mrs
            if mihomo convert-ruleset "$BEHAVIOR" text temp.txt "$FILENAME" 2> mihomo_err.log; then
              echo "Success: $FILENAME generated."
              
              # 检查内容是否有变化 (通过对比备份文件)
              if [[ ! -f "$FILENAME.bak" ]] || ! cmp -s "$FILENAME" "$FILENAME.bak" 2>/dev/null; then
                cp "$FILENAME" "$FILENAME.bak"
                CHANGED=true
                git add "$FILENAME"
                ((PROCESSED++))
              fi
            else
              echo "Error: Mihomo conversion failed for $FILENAME"
              cat mihomo_err.log
            fi
            
            rm -f temp_raw.txt temp.txt mihomo_err.log
          done
          
          set -e
          
          # 4. 提交并推送更改
          if [[ "$CHANGED" == true ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git commit -m "Auto-update: $PROCESSED MRS files [$(date +'%Y-%m-%d')]"
            git push
            echo "Workflow complete. Updated $PROCESSED files."
          else
            echo "No changes detected in any rulesets."
          fi

      - name: Cleanup
        if: always()
        run: rm -f temp_raw.txt temp.txt *.bak mihomo_err.log
